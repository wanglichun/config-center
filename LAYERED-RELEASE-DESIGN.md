# ğŸš€ åˆ†å±‚åˆ†ç»„å‘å¸ƒæµç¨‹è®¾è®¡

## ğŸ“‹ æ¦‚è¿°

åˆ†å±‚åˆ†ç»„å‘å¸ƒæ˜¯ä¸€ç§æ›´å®‰å…¨ã€æ›´å¯æ§çš„é…ç½®å‘å¸ƒç­–ç•¥ï¼Œé€šè¿‡å°†è®¢é˜…é…ç½®çš„æœºå™¨åˆ†æˆ3å±‚è¿›è¡Œé€æ­¥å‘å¸ƒï¼Œç¡®ä¿é…ç½®å˜æ›´çš„å®‰å…¨æ€§å’Œå¯å›æ»šæ€§ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. æ•´ä½“æµç¨‹æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åˆ†å±‚åˆ†ç»„å‘å¸ƒæµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   1. æ‹‰å–é…ç½®è®¢é˜…æœºå™¨åˆ—è¡¨                         â”‚
â”‚   â€¢ æ ¹æ® appNameã€environmentã€configKey æŸ¥è¯¢                    â”‚
â”‚   â€¢ è·å–æ‰€æœ‰è®¢é˜…æ­¤é…ç½®çš„æœºå™¨å®ä¾‹                                   â”‚
â”‚   â€¢ è¿‡æ»¤æ‰ç¦»çº¿æˆ–å¼‚å¸¸çš„æœºå™¨                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   2. æœºå™¨åˆ†å±‚åˆ†ç»„ç­–ç•¥                             â”‚
â”‚   ç¬¬ä¸€å±‚ (é‡‘ä¸é›€å±‚): 5%  - 1-2å°æœºå™¨ï¼ŒéªŒè¯é…ç½®æ­£ç¡®æ€§              â”‚
â”‚   ç¬¬äºŒå±‚ (ç°åº¦å±‚):  25% - å‰©ä½™æœºå™¨çš„30%ï¼Œå°èŒƒå›´éªŒè¯               â”‚
â”‚   ç¬¬ä¸‰å±‚ (å…¨é‡å±‚):  70% - å‰©ä½™æ‰€æœ‰æœºå™¨ï¼Œå…¨é‡å‘å¸ƒ                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   3. åˆ†å±‚å‘å¸ƒæ‰§è¡Œæµç¨‹                             â”‚
â”‚   Layer 1 â†’ éªŒè¯ â†’ Layer 2 â†’ éªŒè¯ â†’ Layer 3 â†’ å®Œæˆ               â”‚
â”‚   æ¯å±‚é—´éš”å¯é…ç½®ï¼Œæ”¯æŒäººå·¥å¹²é¢„å’Œè‡ªåŠ¨å›æ»š                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æœºå™¨åˆ†å±‚ç®—æ³•

```java
/**
 * æœºå™¨åˆ†å±‚åˆ†ç»„ç®—æ³•
 */
public class LayeredReleaseStrategy {
    
    // åˆ†å±‚é…ç½®
    private static final double LAYER_1_PERCENTAGE = 0.05;  // 5%
    private static final double LAYER_2_PERCENTAGE = 0.25;  // 25%
    private static final double LAYER_3_PERCENTAGE = 0.70;  // 70%
    
    // æœ€å°æœºå™¨æ•°é‡ä¿è¯
    private static final int MIN_LAYER_1_COUNT = 1;
    private static final int MIN_LAYER_2_COUNT = 2;
    
    public LayeredMachineGroups splitMachines(List<MachineInstance> machines) {
        int totalCount = machines.size();
        
        // è®¡ç®—æ¯å±‚æœºå™¨æ•°é‡
        int layer1Count = Math.max(MIN_LAYER_1_COUNT, (int)(totalCount * LAYER_1_PERCENTAGE));
        int layer2Count = Math.max(MIN_LAYER_2_COUNT, (int)(totalCount * LAYER_2_PERCENTAGE));
        int layer3Count = totalCount - layer1Count - layer2Count;
        
        // åˆ†å±‚ç­–ç•¥ï¼šä¼˜å…ˆé€‰æ‹©ç¨³å®šæ€§è¾ƒé«˜çš„æœºå™¨ä½œä¸ºç¬¬ä¸€å±‚
        Collections.sort(machines, new MachineStabilityComparator());
        
        return LayeredMachineGroups.builder()
            .layer1(machines.subList(0, layer1Count))
            .layer2(machines.subList(layer1Count, layer1Count + layer2Count))
            .layer3(machines.subList(layer1Count + layer2Count, totalCount))
            .build();
    }
}
```

## ğŸ”„ å‘å¸ƒæµç¨‹è¯¦ç»†è®¾è®¡

### 1. åˆ›å»ºåˆ†å±‚å‘å¸ƒè®¡åˆ’

```java
@PostMapping("/api/layered-release/plan")
public ApiResult<Long> createLayeredPlan(@RequestBody LayeredReleaseRequest request) {
    // 1. æ‹‰å–é…ç½®è®¢é˜…æœºå™¨åˆ—è¡¨
    List<MachineInstance> subscribedMachines = machineGroupService
        .getSubscribedMachines(request.getAppName(), request.getEnvironment(), request.getConfigKeys());
    
    // 2. æœºå™¨åˆ†å±‚åˆ†ç»„
    LayeredMachineGroups machineGroups = layeredReleaseStrategy.splitMachines(subscribedMachines);
    
    // 3. åˆ›å»ºå‘å¸ƒè®¡åˆ’
    LayeredReleasePlan plan = LayeredReleasePlan.builder()
        .planName(request.getPlanName())
        .appName(request.getAppName())
        .environment(request.getEnvironment())
        .configKeys(request.getConfigKeys())
        .totalMachines(subscribedMachines.size())
        .layer1Machines(machineGroups.getLayer1())
        .layer2Machines(machineGroups.getLayer2())
        .layer3Machines(machineGroups.getLayer3())
        .currentLayer(1)
        .status("DRAFT")
        .autoAdvance(request.isAutoAdvance())
        .layerInterval(request.getLayerInterval()) // å±‚é—´é—´éš”æ—¶é—´
        .build();
    
    return ApiResult.success(layeredReleasePlanService.createPlan(plan));
}
```

### 2. åˆ†å±‚å‘å¸ƒæ‰§è¡Œæµç¨‹

```java
@Service
public class LayeredReleaseExecutor {
    
    @Async
    public void executeLayeredRelease(Long planId) {
        LayeredReleasePlan plan = layeredReleasePlanService.getPlan(planId);
        
        try {
            // ç¬¬ä¸€å±‚å‘å¸ƒ
            executeLayer1(plan);
            
            // éªŒè¯ç¬¬ä¸€å±‚
            if (validateLayer(plan, 1)) {
                // ç­‰å¾…å±‚é—´é—´éš”
                Thread.sleep(plan.getLayerInterval() * 1000);
                
                // ç¬¬äºŒå±‚å‘å¸ƒ
                executeLayer2(plan);
                
                // éªŒè¯ç¬¬äºŒå±‚
                if (validateLayer(plan, 2)) {
                    // ç­‰å¾…å±‚é—´é—´éš”
                    Thread.sleep(plan.getLayerInterval() * 1000);
                    
                    // ç¬¬ä¸‰å±‚å‘å¸ƒ
                    executeLayer3(plan);
                    
                    // éªŒè¯ç¬¬ä¸‰å±‚
                    if (validateLayer(plan, 3)) {
                        completePlan(plan);
                    }
                }
            }
        } catch (Exception e) {
            log.error("åˆ†å±‚å‘å¸ƒæ‰§è¡Œå¤±è´¥", e);
            handleReleaseFailure(plan, e);
        }
    }
}
```

## ğŸ“Š æ ¸å¿ƒç‰¹æ€§

1. **æ™ºèƒ½åˆ†å±‚**: æ ¹æ®æœºå™¨ç¨³å®šæ€§å’Œè´Ÿè½½æƒ…å†µæ™ºèƒ½åˆ†å±‚
2. **æ¸è¿›å¼å‘å¸ƒ**: ä»å°èŒƒå›´åˆ°å¤§èŒƒå›´é€æ­¥æ¨è¿›
3. **è‡ªåŠ¨éªŒè¯**: æ¯å±‚å‘å¸ƒåè‡ªåŠ¨éªŒè¯é…ç½®ç”Ÿæ•ˆæƒ…å†µ
4. **å¿«é€Ÿå›æ»š**: æ”¯æŒä»»æ„å±‚çº§çš„å¿«é€Ÿå›æ»š
5. **å®æ—¶ç›‘æ§**: å…¨ç¨‹ç›‘æ§å‘å¸ƒè¿›åº¦å’Œæœºå™¨çŠ¶æ€
6. **äººå·¥å¹²é¢„**: æ”¯æŒæ‰‹åŠ¨æ§åˆ¶å‘å¸ƒèŠ‚å¥

## ğŸ¯ åº”ç”¨åœºæ™¯

- **æ•°æ®åº“é…ç½®å˜æ›´**: è¿æ¥æ± ã€è¶…æ—¶è®¾ç½®ç­‰å…³é”®é…ç½®
- **ç¼“å­˜é…ç½®ä¼˜åŒ–**: Redisé›†ç¾¤ã€ç¼“å­˜ç­–ç•¥è°ƒæ•´
- **åŠŸèƒ½å¼€å…³å‘å¸ƒ**: æ–°åŠŸèƒ½çš„æ¸è¿›å¼å¯ç”¨
- **æ€§èƒ½å‚æ•°è°ƒä¼˜**: JVMå‚æ•°ã€çº¿ç¨‹æ± é…ç½®ç­‰
- **å®‰å…¨é…ç½®æ›´æ–°**: è®¤è¯ã€æˆæƒç›¸å…³é…ç½®å˜æ›´

è¿™ä¸ªåˆ†å±‚åˆ†ç»„å‘å¸ƒè®¾è®¡æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„ã€å¯æ§çš„ã€å®‰å…¨çš„é…ç½®å‘å¸ƒæ–¹æ¡ˆï¼Œèƒ½å¤Ÿæœ‰æ•ˆé™ä½é…ç½®å˜æ›´çš„é£é™©ï¼Œæé«˜å‘å¸ƒçš„æˆåŠŸç‡ã€‚ 