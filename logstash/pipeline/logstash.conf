input {
  kafka {
    bootstrap_servers => "kafka:29092"
    topics => ["api-logs", "zk-logs", "redis-logs", "mysql-logs", "trace-logs"]
    codec => json
    client_id => "logstash"
    group_id => "logstash-group"
    auto_offset_reset => "latest"
  }
}

filter {
  # 添加时间戳
  if [timestamp] {
    date {
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss" ]
      target => "@timestamp"
    }
  }
  
  # 处理TraceId
  if [traceId] {
    mutate {
      add_field => { "trace_id" => "%{[traceId]}" }
    }
  }
  
  # 处理组件类型
  if [category] {
    mutate {
      add_field => { "component" => "%{[category]}" }
    }
  }
  
  # 处理操作类型
  if [operation] {
    mutate {
      add_field => { "operation_type" => "%{[operation]}" }
    }
  }
  
  # 处理响应时间
  if [duration] {
    mutate {
      convert => { "duration" => "integer" }
    }
  }
  
  # 处理状态码
  if [data] and [data][statusCode] {
    mutate {
      add_field => { "status_code" => "%{[data][statusCode]}" }
    }
  }
  
  # 处理客户端IP
  if [data] and [data][clientIp] {
    mutate {
      add_field => { "client_ip" => "%{[data][clientIp]}" }
    }
  }
  
  # 处理用户ID
  if [data] and [data][userId] {
    mutate {
      add_field => { "user_id" => "%{[data][userId]}" }
    }
  }
  
  # 处理SQL语句
  if [data] and [data][sql] {
    mutate {
      add_field => { "sql_text" => "%{[data][sql]}" }
    }
  }
  
  # 处理Redis键
  if [data] and [data][key] {
    mutate {
      add_field => { "redis_key" => "%{[data][key]}" }
    }
  }
  
  # 处理ZK路径
  if [data] and [data][path] {
    mutate {
      add_field => { "zk_path" => "%{[data][path]}" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logs-%{+YYYY.MM.dd}"
    document_type => "_doc"
    action => "index"
  }
  
  # 调试输出
  stdout {
    codec => rubydebug
  }
} 